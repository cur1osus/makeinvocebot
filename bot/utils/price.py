from dataclasses import dataclass
from decimal import Decimal, ROUND_HALF_UP
import re
from difflib import get_close_matches

TEXT = """
Куриные рулетики в панировке с зеленью — 800₽/кг
Куриные рулетики в панировке с грибами — 800₽/кг
Куриные рулетики в панировке с сыром — 800₽/кг
Котлеты по-киевски — 800₽/кг
Кордон блю — 800₽/кг
Котлеты по-донбасски (говядина + свинина) — 800₽/кг
Люля-кебаб свино-говяжий — 800₽/кг
Котлеты бургерные свино-говяжьи — 825₽/кг
Котлеты бургерные куриные — 775₽/кг
Котлеты рыбные — 675₽/кг
Котлеты рыбные без панировки — 700₽/кг
Котлеты куриные — 675₽/кг
Котлеты куриные без панировки — 675₽/кг
Котлеты свиные — 700₽/кг
Котлеты свино-говяжьи — 725₽/кг
Котлеты из индейки без панировки — 800₽/кг
Отбивные куриные — 675₽/кг
Отбивные свиные — 725₽/кг
Тефтели из курицы — 650₽/кг
Тефтели из свинины — 650₽/кг
Тефтели свино-говяжьи — 700₽/кг
Солянка с курицей и копчёностями — 225₽ (0.5 л)
Суп со свиными фрикадельками и с курицей — 200₽ (0.5 л)
Суп сырный с шампиньонами и с курицей — 200₽ (0.5 л)
Борщ домашний — 200₽ (0.5 л)
Куриный суп лапша — 200₽ (0.5 л)
Суп гороховый с копчёной курицей — 200₽ (0.5 л)
Суп харчо с курицей — 200₽ (0.5 л)
Лагман с говядиной — 225₽ (0.5 л)
Тайский суп (Том Ям с морепродуктами, грибами и острой заправкой) — 375₽ (0.5 л)
Уха с сёмгой — 300₽ (0.5 л)
Жюльен — 250₽ (300 г)
Паста карбонара — 250₽ (450 г)
Паста болоньезе — 250₽ (450 г)
Картофельное пюре с куриной отбивной (с помидором и сыром сверху) — 250₽ (450 г)
Бризоль (рулет, внутри сыр и помидор) с картофельным пюре — 250₽ (450 г)
Рис в сливочном соусе и минтай в кляре (с помидором и сыром сверху) — 250₽ (380 г)
Вареники с картошкой — 425₽/кг
Вареники картошка + грибы — 450₽/кг
Вареники картошка + печень — 450₽/кг
Вареники с капустой — 425₽/кг
Вареники с солёным творогом и укропом — 450₽/кг
Вареники с творогом — 450₽/кг
Вареники с вишней — 750₽/кг
Пельмени с курицей — 600₽/кг
Пельмени со свининой — 600₽/кг
Пельмени свино-говяжьи — 600₽/кг
Пельмени с индейкой — 600₽/кг
Пельмени с креветкой, творожным сыром и чесноком — 975₽/кг
Манты с курицей — 650₽/кг
Манты со свининой — 650₽/кг
Манты говядина + свинина — 700₽/кг
Чебуреки с курицей — 750₽/кг
Чебуреки со свининой — 750₽/кг
Чебуреки с сыром — 750₽/кг
Самса с курицей — 675₽/кг
Слойки с вишней — 625₽/кг
Слойки с абрикосом — 600₽/кг
Слойки с шоколадом — 600₽/кг
Слойки с клубникой — 600₽/кг
Слойки с курицей, сыром и помидором — 650₽/кг
Слойки с яблоком — 625₽/кг
Кубете — 650₽/кг
Хачапури с сыром — 625₽/кг
Сырники — 550₽/кг
Сырники с изюмом — 575₽/кг
Блины с курицей — 625₽/кг
Блины с курицей и грибами — 625₽/кг
Блины с мясом (свинина) — 625₽/кг
Блины с творогом — 600₽/кг
Блины с ветчиной и сыром — 625₽/кг
Блины с вишней, маком и творогом (трио) — 750₽/кг
Блины жюльен (сыр + грибы) — 625₽/кг
Блины с яблоками и корицей — 575₽/кг
Блины картофель + грибы — 525₽/кг
Блины картофель + печень — 525₽/кг
Блины с сёмгой и творожным сыром — 1425₽/кг
Голубцы с курицей — 650₽/кг
Голубцы со свининой — 650₽/кг
Голубцы свино-говяжьи — 700₽/кг
Фаршированный перец с курицей — 650₽/кг
Фаршированный перец свино-говяжий — 700₽/кг
Картофельные зразы с курицей — 650₽/кг
Картофельные зразы с курицей и грибами — 700₽/кг
Стейк зуратки (150-400 гр): 700 ₽(651 ₽, скидка от 0,5 кг)
Стейк семги (250-350 гр): 2170 ₽(2018 ₽, скидка от 0,5 кг)
Стейк кеты (250-500 гр): 940 ₽(874 ₽, скидка от 0,5 кг)
Килька пряный посол: 390 ₽(363 ₽, скидка от 0,5 кг)
Сельдь по-домашнему в уксусе масляной заливке: 720 ₽(670 ₽, скидка от 0,5 кг)
Сардина (мясо тушки в масле скумбрия в масле): 750 ₽(697 ₽, скидка от 0,5 кг)
Горель по-тайски масле морской коктейль в масле с ЛОСОСЕМ (5 компонентов): 2500 ₽(2325 ₽, скидка от 0,5 кг)
Мидии в укс.-мас. заливке: 1250 ₽(1162 ₽, скидка от 0,5 кг)
Дорадо ЖЕЕР (450-500 гр): 230 ₽(214 ₽, скидка от 0,5 кг)
Кнепи из ИКРЫ СОСА (300-350 гр): 190 ₽(177 ₽, скидка от 0,5 кг)
Кнепи из СЕЛЁДКА (300-350 гр): 165 ₽(153 ₽, скидка от 0,5 кг)
Рупет КИЖУЧ (300-400 гр): 300 ₽(279 ₽, скидка от 0,5 кг)
Филе кижуч, морской гребешок, икра тобико: 370 ₽(344 ₽, скидка от 0,5 кг)
Рупет лосось, тигровая креветка, творожный сыр, зелень: 200 ₽(186 ₽, скидка от 0,5 кг)
Филе тунец, морской гребешок, сливочный сыр: 300 ₽(279 ₽, скидка от 0,5 кг)
Филе форель (300-400 гр): 185 ₽(172 ₽, скидка от 0,5 кг)
Сивас с овощами (400-450 гр): 200 ₽(186 ₽, скидка от 0,5 кг)
Сивас с томатами (300-450 гр): 320 ₽(297 ₽, скидка от 0,5 кг)
Шашлычки из СЕЛЁДКИ и ШПИНАТОМ (300-400 гр): 470 ₽(437 ₽, скидка от 0,5 кг)
Шашлычки с гребешком в беконе (200-250 гр): 240 ₽(223 ₽, скидка от 0,5 кг)
Гребешки с моцареллой (3 шт.): 620 ₽(576 ₽, скидка от 0,5 кг)
Селень и моцарелла чеснок под муссой пармезана: 550 ₽(511 ₽, скидка от 0,5 кг)
Мидии тобико (бут.) 200 гр. ун.: 550 ₽(511 ₽, скидка от 0,5 кг)
Креветки в панировке (40/50), (1 кг.): 1650 ₽(1534 ₽, скидка от 0,5 кг)
Колбаса ПАЛЛАРЬ в кляре (1 кг.): 1150 ₽(1069 ₽, скидка от 0,5 кг)
Сырные палочки (1 кг.): 1050 ₽(976 ₽, скидка от 0,5 кг)
Наггетсы куриные в темпуре: 850 ₽(790 ₽, скидка от 0,5 кг)
Навор том ЯМ суп на 2 порции (НЕ острый) (370 гр.): 775 ₽(720 ₽, скидка от 0,5 кг)
Навор том ЯМ суп на 2 порции (ОСТРЫЙ) (370 гр.): 775 ₽(720 ₽, скидка от 0,5 кг)
Навор том КХА суп на 2 порции (400 гр.): 800 ₽(744 ₽, скидка от 0,5 кг)
Навор удон с морепродуктами на 2 порции (390 гр.): 825 ₽(767 ₽, скидка от 0,5 кг)
Креветки (31-40) сырые: 980 ₽(911 ₽, скидка от 0,5 кг)
Креветки тигровые сырые лангустины (гол. и гол.), вареные креветки очищенные с хвостом (26/30), сырые: 1250 ₽(1162 ₽, скидка от 0,5 кг)
Креветки очищенные с хвостом (26/30), сырые: 1520 ₽(1414 ₽, скидка от 0,5 кг)
Креветки северная (120+), вареная: 1240 ₽(1153 ₽, скидка от 0,5 кг)
Креветки ванаamey (40-50), сырая: 850 ₽(828 ₽, скидка от 0,5 кг)
Креветки белоногая (50-70), вареная: 870 ₽(809 ₽, скидка от 0,5 кг)
Креветки очищенная варено-мороженые (200-300 шт): 1400 ₽(1302 ₽, скидка от 0,5 кг)
Калмар (филе) (~250-300 гр): 920 ₽(856 ₽, скидка от 0,5 кг)
Салат чукча: 550 ₽(511 ₽, скидка от 0,5 кг)
Краевые палочки columbus мясо рапана морской коктейль (кальм, креветки, мидии, кальмар, лангустины): 750 ₽(1209 ₽, скидка от 0,5 кг)
Осьминоги (филе) (40/60): 1190 ₽(1107 ₽, скидка от 0,5 кг)
Мидии в подливке (30-45 шт.): 670 ₽(623 ₽, скидка от 0,5 кг)
Филе тревика (свежемороженое, (80-100 шт. на 1 кг)): 3250 ₽(3022 ₽, скидка от 100 гр)
Икра осетра премиум (черная) (~250 гр, пастеризован тара): 3000 ₽(2790 руб)
Икра осетра премиум (черная) (~50 гр, стекло): 4500 ₽(4557 руб)
Икра осетра премиум (черная) (~100 гр, стекло): 9500 ₽(9114 руб)
Карась (~200 гр): 1190 ₽(1106 ₽, скидка от 0,5 кг)
Вомер (~200-300 гр): 395 ₽(367 ₽, скидка от 0,5 кг)
Кефаль (тополови) (~400 гр): 1070 ₽(995 ₽, скидка от 0,5 кг)
Окунь (~300-500 гр): 1050 ₽(976 ₽, скидка от 0,5 кг)
Масляная (филе на коже) (~1-5 кг): 1950 ₽(1813 ₽, скидка от 0,5 кг)
Скумбрия (~300-350 гр): 1000 ₽(930 ₽, скидка от 0,5 кг)
Шипальца калимача (40-60 шт. на 1 кг): 2140 ₽(1990 ₽, скидка от 0,5 кг)
Толстолоб (1-2 кг): 670 ₽(623 ₽, скидка от 0,5 кг)
Килька толька: 600 ₽(558 ₽, скидка от 0,5 кг)
Сардину (ивси) ивсикоокеанская филе сельдь атлантической ставрида (~600-800 гр): 630 ₽(586 ₽, скидка от 0,5 кг)
Горбуша (~1-2 кг): 1450 ₽(1348 ₽, скидка от 0,5 кг)
Бычок (ошпаренный) (~50 гр): 2400 ₽(2232 ₽, скидка от 100 гр)
Камбала (еловрюха) (~300-500 гр): 1270 ₽(1181 ₽, скидка от 100 гр)
Кефаль (шаланда) (~400 гр): 870 ₽(809 ₽, скидка от 100 гр)
Лещ астраханский (~200-300 гр): 615 ₽(572 ₽, скидка от 100 гр)
Лещ шмплянский (~700-900 гр): 820 ₽(762 ₽, скидка от 100 гр)
Плоти (~100-150 гр): 780 ₽(725 ₽, скидка от 100 гр)
Судак (~200-400 гр): 850 ₽(790 ₽, скидка от 100 гр)
Чехонь (~150 гр): 1020 ₽(948 ₽, скидка от 100 гр)
Вобла (~100 гр): 1200 ₽(1190 ₽, скидка от 100 гр)
Вомер (150-200 гр): 0,5 кг 650 ₽ (641 ₽), 1 кг 642 ₽ (474 ₽)
Лакедра (800-1,5 кг): 0,5 кг 510 ₽ (474 ₽), 1 кг 1135 ₽
Дорадо (400-600 гр): 0,5 кг 1220 ₽, 1 кг 1135 ₽
Скумбрия неразделанная (400-600 гр): 0,5 кг 620 ₽, 1 кг 577 ₽
Ставрида головон (900+ гр): 0,5 кг 450 ₽, 1 кг 419 ₽
Хек (300-400 гр): 0,5 кг 650 ₽, 1 кг 604 ₽
Терпуг (1-1,5 кг): 0,5 кг 550 ₽, 1 кг 548 ₽
Кихучь без головы (4+ кг, Чили): 0,5 кг 1650 ₽, 1 кг 1535 ₽
Кета потрошеная без головы (1-1,5 кг): 0,5 кг 970 ₽, 1 кг 902 ₽
Форель без головы (1-1,5 кг, Турция): 0,5 кг 1490 ₽, 1 кг 1386 ₽
Форель без головы (2-7,4 кг, Турция): 0,5 кг 1660 ₽, 1 кг 1572 ₽
Семга с головой (5-6 кг, Чили, премиум): 0,5 кг 1950 ₽, 1 кг 1850 ₽
Филе пангасиуса свежемороженое (500-600 гр): 0,5 кг 400 ₽, 1 кг 372 ₽
Филе сельди свежемороженое (150 гр): 0,5 кг 440 ₽, 1 кг 409 ₽
Филе пантуса свежемороженое, на коже (200-300 гр): 0,5 кг 450 ₽, 1 кг 678 ₽
Филе окуня свежемороженое, на коже (200-300 гр): 0,5 кг 750 ₽, 1 кг 697 ₽
Филе трески свежемороженое, на коже (500-600 гр): 0,5 кг 850 ₽, 1 кг 828 ₽
Филе судака свежемороженое, на коже (350-550 гр): 0,5 кг 950 ₽, 1 кг 921 ₽
Филе тиляпии свежемороженое (150-200 гр): 0,5 кг 900 ₽, 1 кг 837 ₽
Филе туна свежемороженое (Tuna Fillet, 2-4, 350-600 гр): 0,5 кг 1280 ₽, 1 кг 1190 ₽
Филе креветки свежемороженое (Shrimp Fillet, 350-600 гр): 0,5 кг 2200 ₽, 1 кг 2130 ₽
Филе гребешков свежемороженое, на коже (Scallop Fillet, 350-500 гр): 0,5 кг 750 ₽, 1 кг 735 ₽
Филе лосося свежемороженое, атл. (Salmon Fillet, 350-600 гр): 0,5 кг 2400 ₽, 1 кг 2316 ₽
Раки варёные замороженные (10-15 шт): 3650 ₽
Раки варёные замороженные (16-24 шт): 3150 ₽
Сыр творожный савушкин (0,9 кг): 875 ₽
Икра "маслото" красная премиум натуральная (500 гр): 650 ₽
Икра "только" красная премиум натуральная (500 гр): 1050 ₽
Хондалии рыбий бульон сухой приправа премиум (1 кг): 1050 ₽
Угорь жареный в унаги 10% (700-800 гр): 2200 ₽
"""


@dataclass
class ItemPrice:
    name: str
    unit_price: Decimal
    discount_threshold: Decimal | None = None  # в кг или шт
    discounted_price: Decimal | None = None  # цена при скидке


def parse_price_line(line: str) -> ItemPrice | None:
    """
    Разбор строки типа: 'Креветки в панировке (40/50), (1 кг.): 1650 ₽(1534 ₽, скидка от 0,5 кг)'
    или: 'Куриные рулетики в панировке с зеленью — 800₽/кг'
    """
    line = line.strip()
    if not line:
        return None

    name_part, *price_parts = re.split(r"—|:", line)
    name = name_part.strip()

    price_info = ":".join(price_parts).strip()

    # Ищем цену, скидку и порог
    base_price_match = re.search(r"(\d+)\s?[₽р]", price_info)
    discount_match = re.search(r"\((\d+)\s?[₽р].*?(\d+[.,]?\d*)\s*(кг|шт)", price_info)

    if base_price_match:
        base_price = Decimal(base_price_match.group(1))

        if discount_match:
            discounted = Decimal(discount_match.group(1))
            threshold = Decimal(discount_match.group(2).replace(",", "."))
            return ItemPrice(
                name=name, unit_price=base_price, discount_threshold=threshold, discounted_price=discounted
            )
        else:
            return ItemPrice(name=name, unit_price=base_price)
    print(name_part)
    return None


def parse_weight_input(input_str: str) -> Decimal:
    """Преобразует строку с весом в килограммы"""
    match = re.match(r"(?i)^\s*([\d.]+)\s*(г|гр|грамм|кг|кг\.?)\s*$", input_str)
    if not match:
        raise ValueError("Некорректный формат веса. Пример: '0.5 кг' или '300 г'")
    amount = Decimal(match.group(1).replace(",", "."))
    unit = match.group(2).lower()
    if "г" in unit and "к" not in unit:
        amount /= 1000
    return amount.quantize(Decimal("0.001"), rounding=ROUND_HALF_UP)


def get_price(item: ItemPrice, amount_str: str) -> Decimal:
    """Вычисляет итоговую цену товара по весу или количеству"""
    is_piece = re.search(r"шт|порц|бут|уп|штук|позиц", amount_str, re.I)

    if is_piece:
        quantity = Decimal(re.sub(r"[^\d.]", "", amount_str).replace(",", "."))
        price = (
            item.discounted_price
            if item.discount_threshold and quantity >= item.discount_threshold
            else item.unit_price
        )
        if price is None:
            raise ValueError("Цена товара не указана")
        total = quantity * price
    else:
        weight_kg = parse_weight_input(amount_str)
        price = (
            item.discounted_price
            if item.discount_threshold and weight_kg >= item.discount_threshold
            else item.unit_price
        )
        if price is None:
            raise ValueError("Цена товара не указана")
        total = weight_kg * price

    return total.quantize(Decimal("0"))


def load_items_from_text(text: str) -> dict[str, ItemPrice]:
    """Парсит текстовый прайс в словарь"""
    items: dict[str, ItemPrice] = {}
    for line in text.splitlines():
        item = parse_price_line(line)
        if item:
            items[item.name] = item
    return items


def find_best_match(user_input: str) -> ItemPrice:
    """Ищет точное или ближайшее совпадение по названию"""
    if user_input in catalog:
        return catalog[user_input]
    else:
        matches = get_close_matches(user_input, catalog.keys(), n=1, cutoff=0.5)
        if matches:
            print(f"[!] Использовано приближённое совпадение: '{matches[0]}' вместо '{user_input}'")
            return catalog[matches[0]]
        else:
            return ItemPrice(unit_price=Decimal(0), name="Unknown")


catalog = load_items_from_text(TEXT)


def calculate_price(name_product: str, quantity: str = "1") -> tuple[str, Decimal]:
    item = find_best_match(name_product)
    price = get_price(item, quantity)
    return item.name, price


for i in catalog:
    if len(i) > 42:
        print(i)
